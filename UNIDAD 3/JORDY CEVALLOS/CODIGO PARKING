#include <stdio.h>
#include <string.h>
#include <ctype.h>

// Estructura que representa un veh√≠culo
typedef struct {
    char placa[20];
    char horaEntrada[10];
    char horaSalida[10];
} Vehiculo;

// Convierte cadena a may√∫sculas
void convertirMayusculas(char *str) {
    for (int i = 0; str[i]; i++) {
        str[i] = toupper((unsigned char) str[i]);
    }
}

// Busca un veh√≠culo por su placa en la lista
int buscarPorPlaca(Vehiculo lista[], int n, char placa[]) {
    for (int i = 0; i < n; i++) {
        if (strcmp(lista[i].placa, placa) == 0) {
            return i; // Si encuentra, retorna la posici√≥n
        }
    }
    return -1; // Si no encuentra, retorna -1
}

// Convierte "HH:MM" en minutos desde medianoche
int convertirHoraAMinutos(const char *hora) {
    int h, m;
    sscanf(hora, "%d:%d", &h, &m);
    return h * 60 + m;
}

// Calcula el precio seg√∫n el tiempo de permanencia
float calcularPrecio(char *entrada, char *salida) {
    int minutosEntrada = convertirHoraAMinutos(entrada);
    int minutosSalida = convertirHoraAMinutos(salida);
    int duracion = minutosSalida - minutosEntrada;

    if (duracion <= 15) return 0.0;
    if (duracion < 60) return 0.50;

    int horasCompletas = duracion / 60;
    int minutosRestantes = duracion % 60;
    float precio = horasCompletas * 0.75;

    if (minutosRestantes >= 30) {
        precio += 0.50;
    }

    return precio;
}

// Muestra la informaci√≥n de un veh√≠culo
void mostrarVehiculo(Vehiculo v) {
    printf("\nPlaca: %s\n", v.placa);
    printf("Hora de entrada: %s\n", v.horaEntrada);
    if (strlen(v.horaSalida) > 0)
        printf("Hora de salida: %s\n", v.horaSalida);
    else
        printf("Hora de salida: (A√∫n en parqueadero)\n");
}

// Elimina un veh√≠culo (resetea sus valores)
void eliminarVehiculo(Vehiculo *v) {
    strcpy(v->placa, "");
    strcpy(v->horaEntrada, "");
    strcpy(v->horaSalida, "");
}

// Registrar entrada con validaci√≥n de placa duplicada sin salida
void registrarEntrada(Vehiculo parqueadero[], int *cantidad, int *puestosDisponibles) {
    if (*puestosDisponibles <= 0) {
        printf("Parqueadero lleno.\n");
        return;
    }

    Vehiculo nuevo;
    printf("Ingrese la placa del veh√≠culo: ");
    fgets(nuevo.placa, 20, stdin);
    nuevo.placa[strcspn(nuevo.placa, "\n")] = '\0';
    convertirMayusculas(nuevo.placa);

    // Validar si la placa ya est√° registrada y sin salida
    int encontrado = -1;
    for (int i = 0; i < *cantidad; i++) {
        if (strcmp(parqueadero[i].placa, nuevo.placa) == 0 && strlen(parqueadero[i].horaSalida) == 0) {
            encontrado = i;
            break;
        }
    }

    if (encontrado != -1) {
        printf("‚ö†Ô∏è Advertencia: El veh√≠culo con placa %s ya est√° registrado SIN SALIDA.\n", nuevo.placa);
        return; // No permite registrar duplicado sin salida
    }

    printf("Ingrese la hora de entrada (HH:MM): ");
    fgets(nuevo.horaEntrada, 10, stdin);
    nuevo.horaEntrada[strcspn(nuevo.horaEntrada, "\n")] = '\0';

    strcpy(nuevo.horaSalida, ""); // Inicializa salida vac√≠a
    parqueadero[*cantidad] = nuevo;
    (*cantidad)++;
    (*puestosDisponibles)--;

    printf("‚úÖ Entrada registrada correctamente.\n");
}

// Registrar la salida del veh√≠culo
void registrarSalida(Vehiculo parqueadero[], int *puestosDisponibles, int cantidad) {
    char placaBuscada[20];
    printf("Ingrese la placa: ");
    fgets(placaBuscada, 20, stdin);
    placaBuscada[strcspn(placaBuscada, "\n")] = '\0';
    convertirMayusculas(placaBuscada);

    int pos = buscarPorPlaca(parqueadero, cantidad, placaBuscada);
    if (pos == -1) {
        printf("‚ùå Veh√≠culo no encontrado.\n");
        return;
    }

    if (strlen(parqueadero[pos].horaSalida) != 0) {
        printf("‚ö†Ô∏è El veh√≠culo ya tiene salida registrada.\n");
        return;
    }

    printf("Ingrese la hora de salida (HH:MM): ");
    fgets(parqueadero[pos].horaSalida, 10, stdin);
    parqueadero[pos].horaSalida[strcspn(parqueadero[pos].horaSalida, "\n")] = '\0';

    float precio = calcularPrecio(parqueadero[pos].horaEntrada, parqueadero[pos].horaSalida);
    printf("Duraci√≥n de estad√≠a: %s - %s\n", parqueadero[pos].horaEntrada, parqueadero[pos].horaSalida);
    printf("üíµ Precio a pagar: $%.2f\n", precio);

    (*puestosDisponibles)++;
}

// PROGRAMA PRINCIPAL
int main() {
    Vehiculo parqueadero[100]; // Array de veh√≠culos
    int cantidad = 0; // Contador de veh√≠culos
    int puestosDisponibles = 60; // Puestos totales
    int opcion;

    while (1) {
        printf("\n--- SISTEMA DE PARQUEADERO ---\n");
        printf("Puestos disponibles: %d / 60\n", puestosDisponibles);
        printf("1. Ingresar veh√≠culo\n");
        printf("2. Registrar salida\n");
        printf("3. Mostrar veh√≠culos\n");
        printf("4. Salir\nOpci√≥n: ");
        scanf("%d", &opcion);
        getchar(); // limpia el buffer

        if (opcion == 1) {
            registrarEntrada(parqueadero, &cantidad, &puestosDisponibles);
        } else if (opcion == 2) {
            registrarSalida(parqueadero, &puestosDisponibles, cantidad);
        } else if (opcion == 3) {
            for (int i = 0; i < cantidad; i++) {
                if (strlen(parqueadero[i].placa) > 0)
                    mostrarVehiculo(parqueadero[i]);
            }
        } else if (opcion == 4) {
            printf("Saliendo del sistema...\n");
            break;
        } else {
            printf("Opci√≥n inv√°lida.\n");
        }
    }

    return 0;
}
